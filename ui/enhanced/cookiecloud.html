<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CookieCloud管理 - SmartMedia Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .cookiecloud-card {
            border-left: 4px solid #0d6efd;
        }
        .sync-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .domain-badge {
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">
                        <i class="bi bi-cloud-arrow-down text-primary me-2"></i>
                        CookieCloud管理
                    </h1>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createClientModal">
                        <i class="bi bi-plus-circle me-1"></i>创建客户端
                    </button>
                </div>
            </div>
        </div>

        <!-- 客户端列表 -->
        <div class="row" id="clientsList">
            <!-- 客户端卡片将通过JavaScript动态生成 -->
        </div>

        <!-- 同步历史 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clock-history text-secondary me-2"></i>
                            同步历史
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="sync-history" id="syncHistory">
                            <!-- 同步历史将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建客户端模态框 -->
    <div class="modal fade" id="createClientModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建CookieCloud客户端</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createClientForm">
                        <div class="mb-3">
                            <label class="form-label">客户端名称</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">服务器地址</label>
                            <input type="url" class="form-control" name="server" 
                                   placeholder="https://your-cookiecloud-server.com" required>
                            <div class="form-text">参考 https://github.com/easychen/CookieCloud 搭建私有服务器</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">用户KEY</label>
                            <input type="text" class="form-control" name="key" required>
                            <div class="form-text">在浏览器CookieCloud插件中获取</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">加密密码</label>
                            <input type="password" class="form-control" name="password" required>
                            <div class="form-text">端对端加密密码，确保安全</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createClient()">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 同步模态框 -->
    <div class="modal fade" id="syncModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">同步Cookie数据</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="syncModalBody">
                    <!-- 同步结果将通过JavaScript动态生成 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadClients();
            loadSyncHistory();
        });

        // 加载客户端列表
        async function loadClients() {
            try {
                const response = await fetch('/api/cookiecloud/clients');
                const result = await response.json();
                
                if (result.success) {
                    renderClients(result.clients);
                } else {
                    showError('加载客户端列表失败');
                }
            } catch (error) {
                showError('网络错误: ' + error.message);
            }
        }

        // 渲染客户端列表
        function renderClients(clients) {
            const container = document.getElementById('clientsList');
            
            if (clients.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="card text-center">
                            <div class="card-body py-5">
                                <i class="bi bi-cloud-slash display-1 text-muted"></i>
                                <h5 class="mt-3">暂无CookieCloud客户端</h5>
                                <p class="text-muted">点击上方按钮创建第一个客户端</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = clients.map(client => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card cookiecloud-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-cloud text-primary me-2"></i>
                                ${client}
                            </h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary" type="button" 
                                        data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="syncClient('${client}')">
                                        <i class="bi bi-arrow-repeat me-2"></i>同步
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="deleteClient('${client}')">
                                        <i class="bi bi-trash me-2"></i>删除
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" onclick="syncClient('${client}')">
                                    <i class="bi bi-arrow-repeat me-1"></i>
                                    立即同步
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 创建客户端
        async function createClient() {
            const form = document.getElementById('createClientForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/cookiecloud/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    $('#createClientModal').modal('hide');
                    form.reset();
                    showSuccess('客户端创建成功');
                    loadClients();
                } else {
                    showError(result.message || '创建失败');
                }
            } catch (error) {
                showError('网络错误: ' + error.message);
            }
        }

        // 同步客户端
        async function syncClient(clientName) {
            try {
                const response = await fetch('/api/cookiecloud/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ client_name: clientName })
                });

                const result = await response.json();
                
                const modalBody = document.getElementById('syncModalBody');
                if (result.success) {
                    modalBody.innerHTML = `
                        <div class="text-center">
                            <i class="bi bi-check-circle text-success display-4"></i>
                            <h5 class="mt-3">同步成功</h5>
                            <p>成功同步 ${result.cookie_count} 个域名的Cookie数据</p>
                            <div class="mt-3">
                                ${result.domains.map(domain => 
                                    `<span class="badge bg-primary domain-badge">${domain}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    modalBody.innerHTML = `
                        <div class="text-center">
                            <i class="bi bi-x-circle text-danger display-4"></i>
                            <h5 class="mt-3">同步失败</h5>
                            <p>${result.message}</p>
                        </div>
                    `;
                }
                
                $('#syncModal').modal('show');
                loadSyncHistory();
                
            } catch (error) {
                showError('网络错误: ' + error.message);
            }
        }

        // 删除客户端
        async function deleteClient(clientName) {
            if (!confirm(`确定要删除客户端 "${clientName}" 吗？`)) {
                return;
            }

            try {
                const response = await fetch(`/api/cookiecloud/${clientName}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('客户端删除成功');
                    loadClients();
                } else {
                    showError(result.message || '删除失败');
                }
            } catch (error) {
                showError('网络错误: ' + error.message);
            }
        }

        // 加载同步历史
        async function loadSyncHistory() {
            try {
                const response = await fetch('/api/cookiecloud/history?limit=10');
                const result = await response.json();
                
                if (result.success) {
                    renderSyncHistory(result.history);
                }
            } catch (error) {
                console.error('加载同步历史失败:', error);
            }
        }

        // 渲染同步历史
        function renderSyncHistory(history) {
            const container = document.getElementById('syncHistory');
            
            if (history.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">暂无同步记录</p>';
                return;
            }

            container.innerHTML = history.map(record => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div>
                        <strong>${record.client}</strong>
                        <small class="text-muted ms-2">${new Date(record.timestamp * 1000).toLocaleString()}</small>
                    </div>
                    <div>
                        <span class="badge bg-success">${record.cookie_count}个Cookie</span>
                    </div>
                </div>
            `).join('');
        }

        // 工具函数
        function showSuccess(message) {
            // 这里可以集成更完善的通知系统
            alert('成功: ' + message);
        }

        function showError(message) {
            // 这里可以集成更完善的通知系统
            alert('错误: ' + message);
        }
    </script>
</body>
</html>